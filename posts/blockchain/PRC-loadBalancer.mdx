---
title: "Load balancer RPC endpoints"
date: "2025-05-29"
tags: ["dev", "Ethereum"]
status: "public"
description: "Did your Dapp cash because of RPC endpoint?"
---

## M·ªôt ng√†y ‚Äútr·ªùi ƒë·∫πp‚Äù v√† DApp b·ªóng d∆∞ng t·∫Øt th·ªü

Ch√†o anh em dev!

N·∫øu anh em t·ª´ng x√¢y d·ª±ng DApp th√¨ ch·∫Øc kh√¥ng l·∫° g√¨ v·ªõi vi·ªác s·ª≠ d·ª•ng RPC endpoint ƒë·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ blockchain. V√† ai c≈©ng bi·∫øt, m·ªôt DApp th√¨ ƒë√¢u c√≥ g·ªçi √≠t RPC - g·ªçi ho√†i, g·ªçi m√£i, t·ª´ vi·ªác fetch block number, ƒë·ªçc smart contract, ƒë·∫øn ki·ªÉm tra balance, v.v‚Ä¶

L√∫c ƒë·∫ßu, m√¨nh c≈©ng gi·ªëng nhi·ªÅu ng∆∞·ªùi, nghƒ© ƒë∆°n gi·∫£n l√† l·∫•y ƒë·∫°i m·ªôt c√°i RPC public t·ª´ [chainlist](https://chainlist.org/), d√°n v√†o l√† xong.

```tsx
import { createPublicClient, http } from "viem";
import { mainnet } from "viem/chains";

const client = createPublicClient({
  chain: mainnet,
  transport: http("https://eth.llamarpc.com"),
});

const blockNumber = await client.getBlockNumber();
```

Nh∆∞ng r·ªìi m·ªôt ng√†y ƒë·∫πp tr·ªùi n·ªç, h·ªá th·ªëng m√¨nh nh·∫≠n ƒë∆∞·ª£c h√†ng lo·∫°t ph·∫£n √°nh t·ª´ ng∆∞·ªùi d√πng: ‚ÄúSao app kh√¥ng load ƒë∆∞·ª£c n·ªØa?‚Äù, "app b·ªã s·∫≠p r·ªìi √†?"...

Ki·ªÉm tra th√¨ m·ªõi t√° ho·∫£: to√†n b·ªô request ƒë·∫øn RPC ƒë·ªÅu tr·∫£ v·ªÅ HTTP 500. C√°i endpoint m√¨nh d√πng - m·ªôt c√°i RPC public quen thu·ªôc - ƒë√£ "ng·ªèm" m√† m√¨nh kh√¥ng h·ªÅ hay bi·∫øt.

## V·∫•n ƒë·ªÅ l·ªõn nh·∫•t: public RPC kh√¥ng ·ªïn ƒë·ªãnh

Public RPC r·∫•t ti·ªán - kh√¥ng c·∫ßn ƒëƒÉng k√Ω, kh√¥ng c·∫ßn token, d√°n v√†o l√† ch·∫°y. Nh∆∞ng c√°i gi√° ph·∫£i tr·∫£ l√† kh√¥ng ai ƒë·∫£m b·∫£o uptime cho b·∫°n.

Khi s·ªë l∆∞·ª£ng ng∆∞·ªùi d√πng qu√° t·∫£i, ho·∫∑c khi b·ªã ch·∫∑n b·ªüi rate limit, th√¨ app c·ªßa b·∫°n coi nh∆∞ n·∫±m im.

Frontend th√¨ c√†ng nguy hi·ªÉm h∆°n v√¨ b·∫°n kh√¥ng ki·ªÉm so√°t ƒë∆∞·ª£c m√¥i tr∆∞·ªùng m·∫°ng c·ªßa ng∆∞·ªùi d√πng.

## V·∫≠y gi·∫£i ph√°p l√† g√¨?

R·∫•t may l√† th∆∞ vi·ªán Viem m√† m√¨nh ƒëang d√πng c√≥ gi·∫£i ph√°p c·ª±c k·ª≥ g·ªçn g√†ng: [fallback](https://viem.sh/docs/clients/transports/fallback).

> Fallback transport cho ph√©p b·∫°n khai b√°o nhi·ªÅu RPC endpoint. N·∫øu m·ªôt c√°i fail, n√≥ s·∫Ω t·ª± ƒë·ªông chuy·ªÉn sang c√°i ti·∫øp theo.

```tsx
import { createPublicClient, fallback, http } from "viem";
import { mainnet } from "viem/chains";

const client = createPublicClient({
  chain: mainnet,
  transport: fallback([
    http("https://eth.llamarpc.com"),
    http("https://eth.meowrpc.com"),
    http("https://1.rpc.thirdweb.com"),
  ]),
});
```

V·ªõi c√°ch n√†y, k·ªÉ c·∫£ khi m·ªôt RPC down, h·ªá th·ªëng v·∫´n ti·∫øp t·ª•c ho·∫°t ƒë·ªông nh·ªù c√°c endpoint d·ª± ph√≤ng.

## T·ªëi ∆∞u h∆°n n·ªØa v·ªõi rank

N·∫øu b·∫°n nghƒ© vi·ªác fallback l√† ƒë·ªß t·ªët r·ªìi th√¨‚Ä¶ Viem c√≤n cho b·∫°n nhi·ªÅu h∆°n th·∫ø!

Ch·ªâ v·ªõi m·ªôt d√≤ng c·∫•u h√¨nh: `{ rank: true }`, Viem s·∫Ω t·ª± ƒë·ªông ƒë√°nh gi√° v√† x·∫øp h·∫°ng c√°c RPC endpoint ƒë·ªÉ ch·ªçn ra c√°i t·ªët nh·∫•t t·∫°i th·ªùi ƒëi·ªÉm hi·ªán t·∫°i.

**C√°ch ho·∫°t ƒë·ªông c·ªßa c∆° ch·∫ø `rank`**

- Ping ƒë·ªãnh k·ª≥: M·ªói 10 gi√¢y (m·∫∑c ƒë·ªãnh), fallback transport s·∫Ω g·ª≠i ping ƒë·∫øn t·ª´ng transport ƒë·ªÉ ki·ªÉm tra ph·∫£n h·ªìi.
- Thu th·∫≠p m·∫´u: Trong 10 l·∫ßn ping g·∫ßn nh·∫•t, h·ªá th·ªëng ghi nh·∫≠n li·ªáu m·ªói transport c√≥ ph·∫£n h·ªìi hay kh√¥ng (ƒë·ªô ·ªïn ƒë·ªãnh) v√† th·ªùi gian ph·∫£n h·ªìi (ƒë·ªô tr·ªÖ).
- T√≠nh ƒëi·ªÉm: S·ª≠ d·ª•ng thu·∫≠t to√°n ƒëi·ªÉm trung b√¨nh c√≥ tr·ªçng s·ªë, h·ªá th·ªëng t√≠nh ƒëi·ªÉm cho m·ªói transport v·ªõi tr·ªçng s·ªë m·∫∑c ƒë·ªãnh l√† 0.7 cho ƒë·ªô ·ªïn ƒë·ªãnh v√† 0.3 cho ƒë·ªô tr·ªÖ.
- ∆Øu ti√™n s·ª≠ d·ª•ng: Transport c√≥ ƒëi·ªÉm s·ªë cao nh·∫•t s·∫Ω ƒë∆∞·ª£c ∆∞u ti√™n s·ª≠ d·ª•ng.

N·∫øu b·∫°n kh√¥ng b·∫≠t `rank`, Viem s·∫Ω `fallback` theo ƒë√∫ng th·ª© t·ª± b·∫°n ƒë√£ khai b√°o. Nh∆∞ng khi b·∫≠t `rank`, Viem s·∫Ω ƒë·ªông n√£o gi√∫p b·∫°n lu√¥n ch·ªçn c√°i ‚Äúngon‚Äù nh·∫•t.

```tsx
const client = createPublicClient({
  chain: mainnet,
  transport: fallback(
    [
      http("https://eth.llamarpc.com"),
      http("https://eth.meowrpc.com"),
      http("https://1.rpc.thirdweb.com"),
    ],
    { rank: true }
  ),
});
```

![so good](https://www.memecreator.com/static/images/memes/322312.jpg)

## x√†i free RPC, v√† c√°i gi√° ph·∫£i tr·∫£‚Ä¶

M√¨nh ngh√®o, n√™n to√†n d√πng m·∫•y RPC public free th√¥i - m·∫•y c√°i n√†y th∆∞·ªùng gi·ªõi h·∫°n ch·ªâ kho·∫£ng 10 requests/gi√¢y. V√† th·∫ø l√† v·∫•n ƒë·ªÅ l·∫°i ti·∫øp di·ªÖn‚Ä¶

> Khi `429 Too Many Requests` tr·ªü th√†nh c∆°n √°c m·ªông

Thay v√¨ m√≥c h·∫ßu bao ra tr·∫£ cho c√°c d·ªãch v·ª• RPC chuy√™n nghi·ªáp (d√π r·∫•t x·ª©ng ƒë√°ng),
t√¥i ch·ªçn m·ªôt con ƒë∆∞·ªùng kh√°c: d√πng th·∫≠t nhi·ªÅu RPC public c√πng l√∫c! M·ªói c√°i c√≥ gi·ªõi h·∫°n ri√™ng, n√™n n·∫øu chia ƒë·ªÅu t·∫£i ra th√¨‚Ä¶ ta c√≥ th·ªÉ s·ªëng s√≥t ƒë∆∞·ª£c üòå.

Ban ƒë·∫ßu, t√¥i d√πng `fallback` nh∆∞ ·ªü tr√™n - c≈©ng ·ªïn, nh∆∞ng ch∆∞a ƒë·ªß. V√¨ `fallback` ch·ªâ d√πng 1 endpoint t·∫°i m·ªôt th·ªùi ƒëi·ªÉm, ch·ªâ khi n√≥ l·ªói th√¨ m·ªõi chuy·ªÉn sang c√°i ti·∫øp theo.
T√¥i mu·ªën chia ƒë·ªÅu t·∫£i ra ngay t·ª´ ƒë·∫ßu, nh∆∞ m·ªôt `load balancer` th·ª±c th·ª•.

V√† r·ªìi t√¥i ph√°t hi·ªán ra: `@ponder/utils` - m·ªôt framework cho blockchain indexer.
N√≥ c√≥ m·ªôt function t√™n l√† `loadBalance`, ƒë√∫ng c√°i t√¥i c·∫ßn!

```tsx
import { loadBalance } from "@ponder/utils";
import { http, createPublicClient, rateLimit } from "viem";
import { mainnet } from "viem/chains";

const client = createPublicClient({
  chain: mainnet,
  transport: loadBalance([
    http("https://eth.llamarpc.com"),
    http("https://eth.meowrpc.com"),
    rateLimit(http("https://1.rpc.thirdweb.com"), { requestsPerSecond: 15 }),
  ]),
});
```

V·∫≠y loadBalance l√†m g√¨?

- ‚öñÔ∏è Round-robin: M·ªói request s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn m·ªôt RPC kh√°c nhau theo th·ª© t·ª±.
- üîÑ Ph√¢n t√°n t·∫£i: Kh√¥ng c√≤n chuy·ªán spam 1 RPC r·ªìi ƒÉn rate limit.
- üí∏ Mi·ªÖn ph√≠ v√† kh√¥ng c·∫ßn token: Ch·ªâ c·∫ßn d√πng c√°c RPC public nh∆∞ b√¨nh th∆∞·ªùng.
- N√≥ kh√¥ng ch·ªâ gi√∫p t√¥i tr√°nh ƒë∆∞·ª£c l·ªói 429, m√† c√≤n tƒÉng ƒë·ªô ·ªïn ƒë·ªãnh c·ªßa app - v√¨ kh√¥ng ph·ª• thu·ªôc v√†o m·ªôt nh√† cung c·∫•p duy nh·∫•t.

![ok](https://tft.edu.vn/public/upload/2024/09/meme-ok-42.webp)

## k·∫øt

N·∫øu b·∫°n ƒëang ph√°t tri·ªÉn DApp v√† v·∫´n ƒëang d√πng m·ªôt RPC duy nh·∫•t th√¨‚Ä¶ h√£y d·ª´ng l·∫°i.

- H√£y d√πng `fallback()` n·∫øu mu·ªën ƒë∆°n gi·∫£n v√† an to√†n.
- H√£y b·∫≠t `{ rank: true }` n·∫øu mu·ªën smart auto switch.
- H√£y th·ª≠ `loadBalance()` n·∫øu mu·ªën chia t·∫£i v√† n√© rate limit nh∆∞ ninja.

> Ch√∫c anh em dev DApp ngon l√†nh m√† kh√¥ng ph·∫£i th·ª©c khuya v√¨ l·ªói 500 hay 429 n·ªØa.
